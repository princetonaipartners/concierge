<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hamilton Deli & Grill — Concierge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1020; --card:#101629; --ink:#e8ecff; --muted:#9aa3b2;
    --brand:#5fe1a5; --brand2:#55c9ff; --accent:#ffd166;
    --ring:#2a375a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
    --border-color: #243055;
    --input-bg: #0e1425;
  }
  html,body{
    margin:0;
    height:100%;
    background:
      radial-gradient(80% 140% at 10% -10%, rgba(85,201,255,.12), transparent 55%),
      radial-gradient(60% 120% at 110% -10%, rgba(95,225,165,.1), transparent 45%),
      var(--bg);
    color:var(--ink);
    font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .wrap{max-width:940px;margin:32px auto;padding:0 18px}
  
  .live-clock {
    text-align: center;
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 16px;
  }
  
  .card{
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:24px;
    position:relative;
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
  }
  /* Screen Transitions */
  .card.screen {
    transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
  }
  .card.screen.hidden {
    opacity: 0;
    transform: translateY(20px);
    pointer-events: none;
    position: absolute; /* Take out of flow when hidden */
    width: calc(100% - 36px); /* Adjust for padding */
    left: 18px;
  }

  h1{margin:0 0 4px;font-weight:800;font-size: 28px; letter-spacing:-.5px}
  h2{margin:0 0 6px;font-weight:700; font-size: 24px;}
  .sub{color:var(--muted);margin-bottom:24px; font-size: 16px;}

  .grid{display:grid;gap:18px}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:1fr 1fr 1fr}
  
  .field{display:flex;flex-direction:column;gap:8px}
  label{font-weight:700; font-size: 15px; color: #c0c8e7;}
  
  input[type="tel"],input[type="number"],input[type="text"]{
    background:var(--input-bg);color:#fff;border:1px solid var(--border-color);border-radius:12px;
    padding:14px;font-size:16px;outline:none;
    transition: all 0.2s ease-in-out;
  }
  input:focus{box-shadow:0 0 0 3px var(--ring);border-color:#37508f}
  .hint{color:var(--muted);font-size:14px}
  
  .tiles{display:flex;flex-wrap:wrap;gap:10px}
  .tile{
    padding:10px 14px;
    border:1px solid #2b355a;
    border-radius:12px;
    cursor:pointer;
    user-select:none;
    background:#0f162a;
    color:#dbe1ff;
    font-weight:700;
    transition: all 0.2s ease-in-out;
  }
  .tile:hover{background: #1c2641; border-color: #374775;}
  .tile.sel{border-color:#59d09f;background:rgba(89,208,159,.12); color: #7de6b8;}
  
  .row{display:flex;align-items:center;gap:10px}
  
  .actions{margin-top:24px;display:flex;gap:12px;flex-wrap:wrap}
  button{padding:14px 20px;border:none;border-radius:12px;font-weight:700;font-size:16px;cursor:pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center;}
  .primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#0811f}
  .primary:hover{filter: brightness(1.1);}
  .ghost{background:#182038;color:#c7d2fe;border:1px solid #2b355a}
  .ghost:hover{background: #212c4b; border-color: #3e4f81;}
  button[disabled]{opacity:.5;cursor:not-allowed; filter: grayscale(50%);}
  
  .banner{
    display:none;
    margin-bottom:20px;
    padding:12px 16px;
    border-radius:12px;
    font-weight:700;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .banner .icon { width: 20px; height: 20px; }
  .ok{background:#123724;color:#9ff3c9;border:1px solid #1f6b49}
  .warn{background:#3a2a07;color:#ffe2a6;border:1px solid #8d6b19}
  .err{background:#3d0f17;color:#ffd0d8;border:1px solid #8f2236}
  
  .kpi{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 2px}
  .chip{
    padding:8px 12px;
    border-radius:10px;
    background:#0d233a;
    border:1px solid #233a57;
    color:#cfe6ff;
    font-weight:700;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .chip .icon { width: 16px; height: 16px; opacity: 0.7; }
  .chip.badge{background:#2a1f00;border-color:#5a4706;color:#ffd978}
  
  .summary{background:var(--input-bg);border:1px solid var(--border-color);border-radius:12px;padding:16px}
  .muted{color:#9aa3b2}
  .big{font-size:22px;font-weight:800}
  .right{margin-left:auto}
  
  /* Summary value update animation */
  .summary .right.updated {
    animation: highlight 0.5s ease-out;
  }
  @keyframes highlight {
    0%, 100% { color: var(--ink); transform: scale(1); }
    50% { color: var(--accent); transform: scale(1.08); }
  }

  hr{border:none;border-top:1px solid #2b355a;margin:12px 0}
  
  .loading[hidden]{display:none !important;}
  .loading{
    position:absolute;
    inset:0;
    background:rgba(10,14,25,.65);
    backdrop-filter:blur(2px);
    border-radius:var(--radius);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    z-index:5;
    font-size: 18px;
    font-weight: 500;
  }
  .spinner{width:24px;height:24px;border-radius:50%;border:4px solid rgba(85,201,255,.25);border-top-color:#55c9ff;animation:spin .9s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* Custom Checkbox */
  .styled-checkbox-wrap {
    position: relative;
    display: flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
    gap: 10px;
  }
  .styled-checkbox-wrap input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }
  .checkmark {
    height: 22px;
    width: 22px;
    background-color: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    transition: all 0.2s ease;
    display: inline-block;
    flex-shrink: 0;
  }
  .styled-checkbox-wrap:hover input ~ .checkmark {
    border-color: #37508f;
  }
  .styled-checkbox-wrap input:checked ~ .checkmark {
    background-color: var(--brand2);
    border-color: var(--brand2);
  }
  .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 7px;
    top: 3px;
    width: 6px;
    height: 12px;
    border: solid white;
    border-width: 0 3px 3px 0;
    transform: rotate(45deg);
  }
  .styled-checkbox-wrap input:checked ~ .checkmark:after {
    display: block;
  }
  .styled-checkbox-wrap[data-disabled="true"] {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  @media (max-width:800px){
    .two,.three{grid-template-columns:1fr}
    h1{ font-size: 24px; }
    .card.screen.hidden { width: calc(100% - 36px * 2); }
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- ICONS -->
  <svg width="0" height="0" style="display:none">
    <symbol id="icon-ok" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></symbol>
    <symbol id="icon-warn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></symbol>
    <symbol id="icon-err" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></symbol>
    <symbol id="icon-phone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></symbol>
    <symbol id="icon-points" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.38 3.49-2.7-2.7a1 1 0 0 0-1.4 0l-6 6a1 1 0 0 0 0 1.4l2.7 2.7c.4.4 1 .4 1.4 0L12.38 5a1 1 0 0 0 0-1.51Z"/><path d="m11.66 7.22-8.43 8.43a1 1 0 0 0 0 1.4l2.7 2.7a1 1 0 0 0 1.4 0l8.43-8.43c.4-.4.4-1 0-1.4L13.06 7.22c-.4-.4-1-.4-1.4 0Z"/><path d="m18 12.5-5-5"/><path d="m12.5 18-5-5"/><circle cx="7.5" cy="16.5" r=".5" fill="currentColor"/><circle cx="16.5" cy="7.5" r=".5" fill="currentColor"/></symbol>
    <symbol id="icon-visits" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></symbol>
  </svg>
  
  <div id="liveClock" class="live-clock"></div>

  <div class="screens-container" style="position: relative;">
    <!-- LOOKUP CARD -->
    <div class="card screen" id="lookupCard" aria-live="polite">
      <div class="loading" id="loadingA" hidden>
        <div class="spinner" aria-hidden="true"></div><div>Working…</div>
      </div>
      <h1>Hamilton Deli & Grill — Cashier</h1>
      <div class="sub">Lookup customer, log purchase, apply rewards.</div>

      <div id="bannerA" class="banner"></div>

      <div class="grid two">
        <div class="field">
          <label for="phone">Customer phone *</label>
          <input id="phone" type="tel" inputmode="tel" placeholder="(555) 123-4567" autocomplete="tel" />
        </div>
        <div class="field" style="justify-content: flex-end;">
          <button class="primary" id="btnLookup">Lookup / Start Visit</button>
        </div>
      </div>

      <div id="enrollBox" style="display:none;margin-top:20px">
        <div class="banner warn" style="display:block">
            <svg class="icon"><use href="#icon-warn" /></svg>
            <span>Customer not enrolled.</span>
        </div>
        <div class="grid two">
          <div>
            <div class="hint">Ask customer to scan to enroll once.</div>
            <div class="tiles" style="margin-top:8px">
              <a class="tile" id="signupLink" target="_blank" rel="noopener">Open Sign-up</a>
              <button class="tile" id="btnShowQR" type="button">Show QR</button>
            </div>
          </div>
          <div id="qrBox" style="display:none">
            <img id="qrImg" alt="Sign-up QR" style="max-width:180px;border-radius:12px;border:1px solid #2b355a"/>
          </div>
        </div>
      </div>
    </div>

    <!-- LOG CARD -->
    <div class="card screen hidden" id="logCard" style="display:none" aria-live="polite">
      <div class="loading" id="loadingB" hidden><div class="spinner"></div><div>Finalizing…</div></div>
      <div id="bannerB" class="banner"></div>

      <div>
          <h2 id="custName">Customer</h2>
          <div class="kpi">
            <span class="chip" id="chipPhone"><svg class="icon"><use href="#icon-phone" /></svg>Phone</span>
            <span class="chip" id="chipPoints"><svg class="icon"><use href="#icon-points" /></svg>Points: 0</span>
            <span class="chip" id="chipVisits"><svg class="icon"><use href="#icon-visits" /></svg>Visits: 0</span>
            <span class="chip" id="chipNext">Next reward in —</span>
            <span class="chip badge" id="chipEligible" style="display:none">Eligible: Free drink</span>
          </div>
      </div>
      
      <div class="summary" style="margin-top: 24px;">
        <div class="row"><div>Subtotal</div><div class="right big" id="sumSubtotal">$0.00</div></div>
        <div class="row"><div class="muted">Reward</div><div class="right" id="sumReward">—</div></div>
        <div class="row"><div class="muted">Review bonus</div><div class="right" id="sumReview">—</div></div>
        <div class="row"><div class="muted">Points discount</div><div class="right" id="sumPts">$0.00</div></div>
        <hr>
        <div class="row"><div class="big">Net to charge</div><div class="right big" id="sumNet">$0.00</div></div>
      </div>

      <div class="field" style="margin-top: 24px;">
        <label for="orderTotal">Order total ($) *</label>
        <input id="orderTotal" type="number" min="0" step="0.01" placeholder="0.00" />
        <div class="hint" id="pointsHint">Points this visit: 0</div>
      </div>
      
      <div class="field" style="gap: 12px; margin-top: 18px;">
        <label class="styled-checkbox-wrap" id="reviewWrap">
            <input type="checkbox" id="reviewVerified">
            <span class="checkmark"></span>
            <span>Review verified in-store (-$5 bonus)</span>
        </label>
        <label class="styled-checkbox-wrap" id="applyWrap">
            <input type="checkbox" id="applyReward" disabled>
            <span class="checkmark"></span>
            <span>Apply free Coffee/20oz drink now</span>
        </label>
      </div>

      <div class="grid two" style="margin-top: 18px;">
        <div class="field">
          <label for="redeemPts">Redeem points</label>
          <input id="redeemPts" type="number" min="0" step="1" placeholder="0" />
          <div class="hint" id="redeemHint">Available: 0 · $0.00 value (100 pts = $5)</div>
        </div>
        <div class="field" style="justify-content: flex-end;">
          <button class="ghost" id="btnMaxRedeem" type="button">Redeem Max</button>
        </div>
      </div>

      <div class="field" style="margin-top:16px">
        <label>Categories in this order</label>
        <div class="tiles" id="catTiles"></div>
        <div class="hint">Tap all that apply.</div>
      </div>

      <div class="actions">
        <button class="primary" id="btnFinalize">Finalize visit</button>
        <button class="ghost" id="btnBack">Start next customer</button>
      </div>
    </div>

    <!-- CONFIRM CARD -->
    <div class="card screen hidden" id="doneCard" style="display:none" aria-live="polite">
      <div class="banner ok" style="display:flex" id="doneMsg">
        <svg class="icon"><use href="#icon-ok" /></svg>
        <span>Visit logged.</span>
      </div>
      <div class="summary">
        <div class="row"><div>Subtotal</div><div class="right" id="doneSubtotal">$0.00</div></div>
        <div class="row"><div>Reward</div><div class="right" id="doneReward">—</div></div>
        <div class="row"><div>Review bonus</div><div class="right" id="doneReview">—</div></div>
        <div class="row"><div>Points discount</div><div class="right" id="donePts">$0.00</div></div>
        <hr>
        <div class="row"><div class="big">Net</div><div class="right big" id="doneNet">$0.00</div></div>
      </div>
      <div class="actions"><button class="primary" id="btnReset">Start next customer</button></div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const WEBHOOK_LOOKUP  = 'https://princetonai.app.n8n.cloud/webhook/cashier/lookup';
const WEBHOOK_FINALIZE= 'https://princetonai.app.n8n.cloud/webhook/cashier/finalize';

const STORE_ID   = 'hamilton-main';   // optional, sent to n8n
const CASHIER_ID = 'register-1';      // optional, sent to n8n

const SIGNUP_URL = 'https://princetonaipartners.github.io/concierge/signup/';
/* ================================================== */

const CATEGORIES = ['Grocery','Convenience','Coffee','Deli/food','Krispy Chicken','Other'];
const REWARD_CYCLE = 5;
const DOLLARS_PER_POINT = 0.05; // 100 points = $5

const $ = q => document.querySelector(q);
const money = v => (Number.isFinite(+v) ? (+v).toLocaleString(undefined,{style:'currency',currency:'USD'}) : '$0.00');
const clamp  = (v,min,max)=> Math.min(max, Math.max(min, v));
const clamp0 = v => Math.max(0, v||0);
const digits10 = v => {
  const d = String(v||'').replace(/\D/g,'');
  return d.length >= 10 ? d.slice(-10) : null;
};

let state = {
  visitId: null,
  phone10: null,
  customer: null,      // from lookup
  eligibleNow: false, // apply free drink now (disabled for lookup flow)
  alreadyToday: false,
  smsOptin: false,
  points: 0,           // current balance
  reviewEligible: false, // can use $5 review bonus
  redeemPts: 0,
};

function setBanner(elId, kind, text){
  const el = $(elId);
  const icons = {'ok': '#icon-ok', 'warn': '#icon-warn', 'err': '#icon-err'};
  const iconHtml = kind && icons[kind] ? `<svg class="icon"><use href="${icons[kind]}" /></svg>` : '';
  el.className = `banner ${kind}`;
  el.innerHTML = text ? `${iconHtml}<span>${text}</span>` : '';
  el.style.display = text ? 'flex' : 'none';
}
function setLoading(id, on){ $(id).hidden = !on; }

function buildTiles(){
  const box = $('#catTiles'); box.innerHTML = '';
  CATEGORIES.forEach(name=>{
    const div = document.createElement('div');
    div.className = 'tile'; div.textContent = name;
    div.addEventListener('click', ()=>{ div.classList.toggle('sel'); recompute(); });
    box.appendChild(div);
  });
}
function selectedCats(){
  return [...document.querySelectorAll('#catTiles .tile.sel')].map(el=>el.textContent);
}

function maxRedeemPtsGivenSubtotal(subtotal, reviewUsed){
  const maxDollarsFromPts = clamp0(subtotal - (reviewUsed ? 5 : 0));
  return Math.floor(maxDollarsFromPts / DOLLARS_PER_POINT);
}

// Helper to flash an element when its value updates
function flashUpdate(el) {
    el.classList.add('updated');
    el.addEventListener('animationend', () => {
        el.classList.remove('updated');
    }, { once: true });
}

function recompute(){
  const subtotal = Number($('#orderTotal').value || 0);
  const reviewUsed = $('#reviewVerified').checked ? 5 : 0;

  const maxPtsBySubtotal = maxRedeemPtsGivenSubtotal(subtotal, !!reviewUsed);
  const desiredPts = Number($('#redeemPts').value || 0);
  const cap = Math.min(state.points, maxPtsBySubtotal);
  state.redeemPts = clamp(desiredPts, 0, cap);
  if (desiredPts !== state.redeemPts) $('#redeemPts').value = state.redeemPts;

  const ptsDollars = state.redeemPts * DOLLARS_PER_POINT;

  const apply = $('#applyReward').checked && state.eligibleNow ? 'FREE Coffee or 20 oz Drink' : '';
  const rewardDiscount = 0;
  const net = clamp0(subtotal - reviewUsed - rewardDiscount - ptsDollars);

  // Update text content
  $('#pointsHint').textContent = `Points this visit: ${Math.max(0, Math.floor(subtotal))}`;
  
  if ($('#sumSubtotal').textContent !== money(subtotal)) {
    $('#sumSubtotal').textContent = money(subtotal);
    flashUpdate($('#sumSubtotal'));
  }
  if ($('#sumReward').textContent !== (apply || '—')) {
    $('#sumReward').textContent = apply || '—';
    flashUpdate($('#sumReward'));
  }
  if ($('#sumReview').textContent !== (reviewUsed ? ('-$'+reviewUsed.toFixed(2)) : '—')) {
    $('#sumReview').textContent = reviewUsed ? ('-$'+reviewUsed.toFixed(2)) : '—';
    flashUpdate($('#sumReview'));
  }
  if ($('#sumPts').textContent !== (ptsDollars ? ('-'+money(ptsDollars)) : '$0.00')) {
    $('#sumPts').textContent = ptsDollars ? ('-'+money(ptsDollars)) : '$0.00';
    flashUpdate($('#sumPts'));
  }
  if ($('#sumNet').textContent !== money(net)) {
    $('#sumNet').textContent = money(net);
    flashUpdate($('#sumNet'));
  }

  const remaining = state.points - state.redeemPts;
  $('#redeemHint').textContent = `Available: ${state.points} · Using ${state.redeemPts} (left ${remaining}) · ${money(state.redeemPts*DOLLARS_PER_POINT)} value (100 pts = $5)`;
  
  $('#applyWrap').dataset.disabled = $('#applyReward').disabled;
  $('#reviewWrap').dataset.disabled = $('#reviewVerified').disabled;
}

const ALL_SCREENS = ['lookupCard', 'logCard', 'doneCard'];
function showScreen(screenId) {
    ALL_SCREENS.forEach(id => {
        const el = $(`#${id}`);
        if (id === screenId) {
            el.style.display = 'block';
            requestAnimationFrame(() => { el.classList.remove('hidden'); });
        } else {
            el.classList.add('hidden');
            el.addEventListener('transitionend', () => {
                if (el.classList.contains('hidden')) el.style.display = 'none';
            }, { once: true });
        }
    });
}

function resetAll(){
  state = { visitId:null, phone10:null, customer:null, eligibleNow:false, alreadyToday:false, smsOptin:false, points:0, reviewEligible:false, redeemPts:0 };
  $('#phone').value='';
  setBanner('#bannerA','',''); setBanner('#bannerB','','');
  $('#enrollBox').style.display='none'; $('#qrBox').style.display='none';
  $('#orderTotal').value='';
  $('#reviewVerified').checked=false;
  $('#applyReward').checked=false;
  $('#applyReward').disabled=true;
  $('#redeemPts').value='0';
  [...document.querySelectorAll('#catTiles .tile')].forEach(el=>el.classList.remove('sel'));
  recompute();
  showScreen('lookupCard');
}

function updateClock() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', second: '2-digit' };
    $('#liveClock').textContent = now.toLocaleDateString('en-US', options);
}

// Initial setup
buildTiles();
resetAll();
updateClock();
setInterval(updateClock, 1000);


/* ---------- Lookup ---------- */
$('#btnLookup').addEventListener('click', async ()=>{
  setBanner('#bannerA','','');
  const phone10 = digits10($('#phone').value);
  if (!phone10){ setBanner('#bannerA','warn','Enter a valid phone number.'); return; }

  setLoading('#loadingA', true);
  try{
    const r = await fetch(WEBHOOK_LOOKUP + `?t=${Date.now()}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone: phone10, storeId: STORE_ID, cashierId: CASHIER_ID })
    });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const res = await r.json();

    if (!res.hasAccount){
      $('#enrollBox').style.display='block';
      $('#signupLink').href = SIGNUP_URL;
      $('#qrImg').src = `https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl=${encodeURIComponent(SIGNUP_URL)}`;
      setBanner('#bannerA','warn', res.message || 'Not enrolled. Ask customer to sign up once.');
      return;
    }

    state.phone10        = phone10;
    state.customer       = res;
    state.alreadyToday   = !!res.alreadyToday;
    state.smsOptin       = !!res.smsOptin;
    state.points         = Number(res.points ?? 0);
    state.reviewEligible = !!res.reviewBonusAvailable;
    state.redeemPts      = 0;
    const willUnlockOnFinalize = !!res.willUnlockOnFinalize;
    state.eligibleNow = false;
    $('#applyReward').checked = false;
    $('#applyReward').disabled = true;

    const name = res.customerName || 'Customer';
    $('#custName').textContent = name;
    $('#chipPhone').innerHTML = `<svg class="icon"><use href="#icon-phone" /></svg> (${phone10.slice(0,3)}) ${phone10.slice(3,6)}-${phone10.slice(6)}`;
    $('#chipPoints').innerHTML = `<svg class="icon"><use href="#icon-points" /></svg> Points: ${state.points}`;
    $('#chipVisits').innerHTML = `<svg class="icon"><use href="#icon-visits" /></svg> Visits: ${Number(res.totalVisits ?? 0)}`;
    const vtn = res.visitsToNextReward;
    $('#chipNext').textContent = Number.isFinite(vtn) ? `Next reward in ${vtn} visit(s)` : 'Next reward —';

    const badge = $('#chipEligible');
    if (willUnlockOnFinalize) {
      badge.style.display = 'inline-flex';
      badge.textContent = 'Unlocks on finalize';
    } else { badge.style.display = 'none'; }

    $('#reviewVerified').disabled = !state.reviewEligible;
    $('#reviewVerified').checked  = false;
    setBanner('#bannerB','','');
    if (!state.alreadyToday) {
      if (!state.reviewEligible) {
        setBanner('#bannerB','warn','Review bonus already used on this account.');
      } else {
        setBanner('#bannerB','ok', `Welcome back${name ? ', ' + name : ''}!`);
      }
    }
    
    $('#redeemPts').value = '0';
    $('#btnFinalize').disabled = !!state.alreadyToday;
    if (state.alreadyToday){
      setBanner('#bannerB','warn','Already checked in today — finalize disabled.');
    }
    
    showScreen('logCard');
    $('#enrollBox').style.display='none';
    recompute();
    setTimeout(() => $('#orderTotal').focus(), 400);
  }catch(e){
    console.error(e);
    setBanner('#bannerA','err','Lookup failed. Check network.');
  }finally{
    setLoading('#loadingA', false);
  }
});

$('#btnShowQR').addEventListener('click', ()=>{
  $('#qrBox').style.display = $('#qrBox').style.display==='none' ? 'block' : 'none';
});

/* ---------- Live recompute on changes ---------- */
$('#orderTotal').addEventListener('input', recompute);
$('#reviewVerified').addEventListener('change', recompute);
$('#applyReward').addEventListener('change', recompute);
$('#redeemPts').addEventListener('input', recompute);

function animateCount(el, start, end, duration) {
    if (start === end) { recompute(); return; }
    let startTime = null;
    const animation = currentTime => {
        if (!startTime) startTime = currentTime;
        const progress = Math.min((currentTime - startTime) / duration, 1);
        el.value = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            requestAnimationFrame(animation);
        } else {
            el.value = end;
            recompute();
        }
    };
    requestAnimationFrame(animation);
}

$('#btnMaxRedeem').addEventListener('click', ()=>{
  const subtotal = Number($('#orderTotal').value || 0);
  const maxBySubtotal = maxRedeemPtsGivenSubtotal(subtotal, $('#reviewVerified').checked);
  const cap = Math.min(state.points, maxBySubtotal);
  const startVal = Number($('#redeemPts').value) || 0;
  animateCount($('#redeemPts'), startVal, cap, 300);
});

/* ---------- Finalize ---------- */
$('#btnFinalize').addEventListener('click', async ()=>{
  const phone10 = state.phone10;
  const subtotal = Number($('#orderTotal').value || 0);
  if (!phone10){ setBanner('#bannerB','warn','Missing phone.'); return; }
  if (!(subtotal >= 0)){ setBanner('#bannerB','warn','Enter a valid order total.'); return; }
  if (state.alreadyToday){ setBanner('#bannerB','warn','Already checked in today.'); return; }

  state.visitId = `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;

  const payload = {
    visitId: state.visitId,
    phone: phone10,
    orderTotal: subtotal,
    categories: selectedCats(),
    reviewVerified: !!$('#reviewVerified').checked,
    redeemPoints: Number(state.redeemPts || 0),
    applyRewards: ($('#applyReward').checked && state.eligibleNow) ? ['FIFTH_VISIT_FREE_DRINK'] : [],
    storeId: STORE_ID,
    cashierId: CASHIER_ID,
  };

  setLoading('#loadingB', true);
  try{
    const r = await fetch(WEBHOOK_FINALIZE, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const res = await r.json();

    const usedPtsDollars = (res.pointsRedeemed ?? state.redeemPts) * DOLLARS_PER_POINT;
    $('#doneSubtotal').textContent = money(res.orderTotal ?? subtotal);
    $('#doneReward').textContent   = res.rewardLabel || (payload.applyRewards.length ? 'FREE Coffee or 20 oz Drink' : '—');
    $('#doneReview').textContent   = (res.reviewBonus ? '-$'+Number(res.reviewBonus).toFixed(2) : '—');
    $('#donePts').textContent      = usedPtsDollars ? ('-'+money(usedPtsDollars)) : '$0.00';
    $('#doneNet').textContent      = money(res.netCharge ?? Math.max(0, subtotal - (res.reviewBonus||0) - usedPtsDollars));
    $('#doneMsg').innerHTML = `<svg class="icon"><use href="#icon-ok" /></svg><span>${res.message || 'Visit logged. SMS will be sent if opted-in.'}</span>`;
    showScreen('doneCard');
  }catch(e){
    console.error(e);
    setBanner('#bannerB','err','Finalize failed. Please retry.');
  }finally{
    setLoading('#loadingB', false);
  }
});

/* ---------- Back / Reset ---------- */
$('#btnBack').addEventListener('click', resetAll);
$('#btnReset').addEventListener('click', resetAll);
</script>
</body>
</html>

